#include "switch.h"        //包含需要的头文件
#include "mqtt.h"       //包含需要的头文件
#include "usart1.h"     //包含需要的头文件
#include "datedown.h"     //包含需要的头文件
#include "stm32f10x.h"  //包含需要的头文件
#include "dht11.h"      //包含所需的头文件

void Data_Down(void) //数据下发处理函数
{
    if(MQTT_CMDOutPtr != MQTT_CMDInPtr) {                            //if成立的话，说明命令缓冲区有数据了
        u1_printf("命令:%s\r\n",&MQTT_CMDOutPtr[2]);                 //串口输出信息
        if(strstr((char *)MQTT_CMDOutPtr+2,"\"params\":{\"Switch1\":1}")) {	          //如果搜索到"params":{"PowerSwitch":1}说明服务器下发打开开关1
            SW1_ON;                                                                   //打开SW1
            SW1_State();                                                              //判断开关状态，并发布给服务器
        }
        else if(strstr((char *)MQTT_CMDOutPtr+2,"\"params\":{\"Switch1\":0}")) {      //如果搜索到"params":{"PowerSwitch":0}说明服务器下发关闭开关1
            SW1_OFF;                                                                  //关闭SW1
            SW1_State();                                                              //判断开关状态，并发布给服务器
        }
        MQTT_CMDOutPtr += CBUFF_UNIT;                             	 //指针下移
        if(MQTT_CMDOutPtr==MQTT_CMDEndPtr)           	             //如果指针到缓冲区尾部了
            MQTT_CMDOutPtr = MQTT_CMDBuf[0];          	             //指针归位到缓冲区开头
    }
		Data_Down_set();
}

void Data_Down_set(void)  //数据处理
{
  u8 tempdata = 0, humidata = 0;	//用于保存温湿度的变量
	DHT11_Read_Data(&tempdata, &humidata);	//读取温湿度值
 if(tempdata>20)
 {
   SW1_ON;                                                                   //打开SW1
   SW1_State();                                                              //判断开关状态，并发布给服务器
 }
 else
 {
   SW1_OFF;                                                                  //关闭SW1
   SW1_State();                                                              //判断开关状态，并发布给服务器
 }

}





